<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>YeTech Admin Dashboard</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
}

header {
  padding: 20px;
  border-bottom: 1px solid #1e293b;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h1 {
  margin: 0;
}

button {
  background: #2563eb;
  color: white;
  border: none;
  padding: 10px 14px;
  border-radius: 8px;
  cursor: pointer;
}

button.secondary {
  background: #334155;
}

main {
  padding: 30px;
}

/* Tabs */
.tab-buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.tab-buttons button {
  background: #334155;
}

.tab-buttons button.active {
  background: #2563eb;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Card Layout */
.card {
  background: #020617;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 0 1px #1e293b;
  margin-bottom: 40px;
}

table {
  width: 100%;
  border-collapse: collapse;
}

td, th {
  padding: 10px;
  border-bottom: 1px solid #1e293b;
  font-size: 14px;
}

ul#locations-list {
  list-style: none;
  padding: 0;
}
</style>
</head>

<body>
<header>
    <div>
        <h1>Admin Dashboard</h1>
        <p>Welcome Donye ðŸ‘‹</p>
    </div>
    <button onclick="logout()">Logout</button>
</header>

<main>
    <!-- Tab Buttons -->
    <div class="tab-buttons">
        <button class="active" onclick="showTab('analyticsTab', this)">Analytics</button>
        <button onclick="showTab('locationsTab', this)">Locations</button>
        <button onclick="showTab('inboxTab', this)">Inbox</button>
    </div>

    <!-- Analytics Tab -->
    <section id="analyticsTab" class="tab-content card active">
        <h2>Website Analytics</h2>
        <label for="timeframeSelect">Select Timeframe:</label>
        <select id="timeframeSelect" onchange="updateChart()">
            <option value="hour">Hourly</option>
            <option value="day" selected>Daily</option>
            <option value="week">Weekly</option>
            <option value="month">Monthly</option>
            <option value="year">Yearly</option>
        </select>
        <canvas id="analyticsChart"></canvas>
        <br>
        <button class="secondary" onclick="exportAnalytics()">Export Analytics CSV</button>
    </section>

    <!-- Locations Tab -->
    <section id="locationsTab" class="tab-content card">
        <h2>Locations</h2>
        <button class="secondary" onclick="clearLocations()">Clear Locations</button>
        <ul id="locations-list" style="margin-top:15px;"></ul>
    </section>

    <!-- Inbox Tab -->
    <section id="inboxTab" class="tab-content card">
        <h2>Email Inbox</h2>
        <table id="inboxTable">
            <thead>
            <tr>
                <th>Email</th>
                <th>Message</th>
                <th>Date</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <br>
        <button class="secondary" onclick="exportInbox()">Export Inbox CSV</button>
    </section>
</main>

<script>
const { createClient } = window.supabase;
const supabaseClient = createClient(
  "https://qtsdprrxuvzfpgitnspj.supabase.co",
  "sb_publishable_gptSk1afRO-l7J1YcvDgSg_tdUX9zv9"
);

/* ðŸ”’ PROTECT PAGE */
supabaseClient.auth.getSession().then(({ data }) => {
  if (!data.session || data.session.user.email !== "yetechsystems@gmail.com") {
    // Use relative path to avoid 404
    window.location.href = "index.html";
  }
});

/* ðŸ”¹ LOGOUT */
async function logout() {
  await supabaseClient.auth.signOut();
  window.location.href = "index.html";
}

/* ðŸ”¹ TABS */
function showTab(tabId, btn){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-buttons button').forEach(b=>b.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  btn.classList.add('active');
}

/* ðŸ“Š ANALYTICS */
let analyticsData = [];
let analyticsChart = null;

async function loadAnalytics() {
  const { data } = await supabaseClient.from("page_views").select("*");
  analyticsData = data || [];

  // Test data
  const testVisitors = [
    { lat: 37.7749, lng: -122.4194, city: "San Francisco", state: "CA", country: "USA", created_at: new Date().toISOString() },
    { lat: 40.7128, lng: -74.0060, city: "New York", state: "NY", country: "USA", created_at: new Date().toISOString() }
  ];

  analyticsData = analyticsData.concat(testVisitors);
  createChart(document.getElementById("timeframeSelect").value);
}

function groupData(timeframe){
  const counts = {};
  analyticsData.forEach(v=>{
    const d = new Date(v.created_at);
    let key;
    switch(timeframe){
      case "hour": key=d.getHours(); break;
      case "day": key=d.toLocaleDateString(); break;
      case "week":
        const onejan=new Date(d.getFullYear(),0,1);
        key=Math.ceil((((d-onejan)/86400000)+onejan.getDay()+1)/7); break;
      case "month": key=`${d.getFullYear()}-${d.getMonth()+1}`; break;
      case "year": key=d.getFullYear(); break;
    }
    counts[key] = (counts[key] || 0) + 1;
  });
  return counts;
}

function createChart(timeframe){
  const counts = groupData(timeframe);
  const ctx = document.getElementById("analyticsChart").getContext("2d");
  if(analyticsChart) analyticsChart.destroy();

  analyticsChart = new Chart(ctx,{
    type:"line",
    data:{
      labels: Object.keys(counts),
      datasets:[{
        label:`${timeframe.charAt(0).toUpperCase()+timeframe.slice(1)} Views`,
        data: Object.values(counts),
        borderColor:"#3b82f6"
      }]
    }
  });
}

function updateChart(){
  createChart(document.getElementById("timeframeSelect").value);
}

/* ðŸ“¬ EMAIL INBOX */
async function loadInbox() {
  const { data } = await supabaseClient.from("contact_messages").select("*").order("created_at",{ascending:false});
  const tbody = document.querySelector("#inboxTable tbody");
  tbody.innerHTML="";
  (data || []).forEach(m=>{
    tbody.innerHTML+=`
      <tr>
        <td>${m.email}</td>
        <td>${m.message}</td>
        <td>${new Date(m.created_at).toLocaleString()}</td>
      </tr>
    `;
  });
}

/* ðŸ“ CSV EXPORTS */
function exportCSV(rows, filename){
  const csv = rows.map(r=>Object.values(r).join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}

async function exportAnalytics(){
  exportCSV(analyticsData, "analytics.csv");
}

async function exportInbox(){
  const { data } = await supabaseClient.from("contact_messages").select("*");
  exportCSV(data, "inbox.csv");
}

/* ðŸŒ LOCATIONS TRACKING */
const maxLocations = 20;
const locationsList = document.getElementById('locations-list');

let locations = JSON.parse(localStorage.getItem('locations')) || [];

function displayLocations() {
    locationsList.innerHTML = '';
    locations.forEach(loc => {
        const li = document.createElement('li');
        li.style.background = '#020617';
        li.style.margin = '8px 0';
        li.style.padding = '12px 15px';
        li.style.borderRadius = '8px';
        li.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.opacity = 0;
        li.style.transform = 'translateY(-10px)';
        li.style.animation = 'fadeIn 0.5s forwards';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = loc.name;
        nameSpan.style.fontWeight = 'bold';

        const infoSpan = document.createElement('span');
        infoSpan.textContent = `${loc.date} at ${loc.time} (${loc.count} view${loc.count>1?'s':''})`;
        infoSpan.style.fontSize = '0.9em';
        infoSpan.style.color = '#cbd5e1';

        li.appendChild(nameSpan);
        li.appendChild(infoSpan);
        locationsList.appendChild(li);
    });
}

function addLocation(name) {
    const now = new Date();
    const date = now.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
    const time = now.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });

    if (locations[0] && locations[0].name === name) {
        locations[0].count += 1;
        locations[0].date = date;
        locations[0].time = time;
    } else {
        locations.unshift({ name, date, time, count:1 });
    }

    if (locations.length > maxLocations) locations.pop();
    localStorage.setItem('locations', JSON.stringify(locations));
    displayLocations();
}

function clearLocations() {
    locations = [];
    localStorage.removeItem('locations');
    displayLocations();
}

async function getUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
                const data = await response.json();
                const city = data.address.city || data.address.town || data.address.village || '';
                const country = data.address.country || '';
                const locationName = city ? `${city}, ${country}` : country;
                addLocation(locationName);
            } catch (err) {
                console.error('Reverse geocoding error:', err);
            }
        }, (error) => {
            console.error('Geolocation error:', error.message);
        });
    } else {
        console.error('Geolocation not supported');
    }
}

// Animation keyframes
const style = document.createElement('style');
style.innerHTML = `
@keyframes fadeIn {
  to { opacity: 1; transform: translateY(0); }
}
`;
document.head.appendChild(style);

// Initialize
displayLocations();
getUserLocation();

// Initialize analytics and inbox
async function initDashboard(){
  await loadAnalytics();
  await loadInbox();
}
initDashboard();

</script>
</body>
</html>
